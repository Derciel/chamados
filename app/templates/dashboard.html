{% extends "base.html" %}
{% block title %}Command Center de Chamados{% endblock %}

{% block extra_styles %}
<style>
    /* Estilos para o tema claro e escuro */
    :root {
        --card-bg-light: rgba(255, 255, 255, 0.7);
        --card-bg-dark: rgba(43, 49, 59, 0.7);
        --card-border-light: rgba(0, 0, 0, 0.1);
        --card-border-dark: rgba(255, 255, 255, 0.2);
    }
    html[data-theme="dark"] body {
        color: #e5e7eb;
    }
    .kpi-card, .main-card {
        background-color: var(--card-bg-light);
        backdrop-filter: blur(10px);
        border: 1px solid var(--card-border-light);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.1) !important;
    }
    html[data-theme="dark"] .kpi-card,
    html[data-theme="dark"] .main-card {
        background-color: var(--card-bg-dark);
        border: 1px solid var(--card-border-dark);
    }
    .kpi-card .trend { font-size: 0.9rem; }

    .table-hover tbody tr.chamado-row { transition: background-color 0.2s ease; cursor: pointer; }
    html[data-theme="dark"] .table-hover tbody tr.chamado-row:hover { background-color: rgba(255, 255, 255, 0.05); }

    .chamado-details-row td { padding: 0 !important; border: 0 !important; }
    .chamado-details-content { background-color: rgba(0,0,0,0.02); padding: 1.25rem; border-top: 1px solid #dee2e6; }
    html[data-theme="dark"] .chamado-details-content { background-color: rgba(0,0,0,0.2); border-top: 1px solid var(--card-border-dark); }

    .user-avatar {
        width: 32px; height: 32px; border-radius: 50%;
        background-color: #0d6efd; color: white;
        display: inline-flex; align-items: center; justify-content: center;
        font-weight: bold; margin-right: 12px; flex-shrink: 0;
    }
    .status-pill {
        padding: 0.3em 0.8em; border-radius: 12px; font-size: 0.85em;
        font-weight: 500; display: inline-flex; align-items: center; gap: 0.5em;
    }
    .tempo-aberto-col {
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<h3 class="form-title text-center mb-4">
  <i class="fa-solid fa-satellite-dish me-2"></i> Painel de Chamados
</h3>

<div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card shadow-sm h-100 kpi-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title text-muted">Abertos</h5>
                    <i class="fa-solid fa-fire text-danger fs-4"></i>
                </div>
                <p class="card-text display-4 fw-bold" id="kpi-abertos">0</p>
                <div class="trend text-success">‚ñ≤ 5% vs ontem</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card shadow-sm h-100 kpi-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title text-muted">Em Andamento</h5>
                    <i class="fa-solid fa-person-digging text-warning fs-4"></i>
                </div>
                <p class="card-text display-4 fw-bold" id="kpi-andamento">0</p>
                <div class="trend text-danger">‚ñº 2% vs ontem</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card shadow-sm h-100 kpi-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title text-muted">Pendentes</h5>
                    <i class="fa-solid fa-clock text-secondary fs-4"></i>
                </div>
                <p class="card-text display-4 fw-bold" id="kpi-pendentes">0</p>
                <div class="trend text-success">‚ñ≤ 10% vs ontem</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card shadow-sm h-100 kpi-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title text-muted">Finalizados Hoje</h5>
                    <i class="fa-solid fa-circle-check text-success fs-4"></i>
                </div>
                <p class="card-text display-4 fw-bold" id="kpi-finalizados-hoje">0</p>
                <div class="trend text-success">‚ñ≤ 8% vs ontem</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm h-100 main-card">
      <div class="card-header fw-bold bg-transparent border-bottom-0">Chamados por Status</div>
      <div class="card-body">
        <canvas id="grafico-status"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm h-100 main-card">
      <div class="card-header fw-bold bg-transparent border-bottom-0">Chamados por Setor</div>
      <div class="card-body">
        <canvas id="grafico-setor"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4 main-card">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0"><i class="fa-solid fa-table-list me-2"></i>Tabela de Chamados</h5>
        <div class="d-flex align-items-center gap-2">
            <input type="text" id="filtro-busca" class="form-control form-control-sm" placeholder="Busca livre...">
            <select id="filtro-setor" class="form-select form-select-sm"></select>
            <select id="filtro-status" class="form-select form-select-sm"></select>
            <button class="btn btn-outline-secondary btn-sm" id="btn-limpar-filtros" title="Limpar Filtros">
                <i class="fa-solid fa-eraser"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm align-middle mb-0" id="tabela-chamados">
                <thead>
                    <tr>
                        <th class="ps-3">ID</th> <th>Abertura</th> <th>Solicitante</th> <th>Setor</th>
                        <th>Status</th> <th>Tempo Aberto</th> <th class="text-end pe-3">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela-chamados"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalChamado" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-dark" id="modal-titulo">Detalhes do Chamado #</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark" id="modal-corpo"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-modal">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block actions %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
    // --- VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ÉO ---
    let todosChamados = [];
    let graficoStatus, graficoSetor;
    let clockInterval = null;
    let audioDesbloqueado = false;
    const notificationSound = new Audio("{{ url_for('static', filename='sounds/msn_notification.mp3') }}");

    // --- L√ìGICA DE INICIALIZA√á√ÉO ---
    document.addEventListener("DOMContentLoaded", () => {
        inicializarGraficos();
        carregarDadosIniciais();
        adicionarListenersDeFiltro();
        adicionarListenerTabela();
        desbloquearAudioComInteracao();
    });

    // --- SOCKET.IO ---
    const socket = io();
    socket.on('connect', () => console.log('‚úÖ Conectado ao servidor real-time!'));
    socket.on('novo_chamado', (novoChamado) => {
        todosChamados.unshift(novoChamado);
        atualizarDashboardCompleto();
        notificationSound.play().catch(e => {});
    });
    socket.on('chamado_atualizado', (chamadoAtualizado) => {
        const index = todosChamados.findIndex(c => c.id === chamadoAtualizado.id);
        if (index !== -1) {
            if (todosChamados[index].status !== chamadoAtualizado.status) {
                notificationSound.play().catch(e => {});
            }
            todosChamados[index] = chamadoAtualizado;
        }
        atualizarDashboardCompleto();
    });
    socket.on('chamado_excluido', (data) => {
        todosChamados = todosChamados.filter(c => c.id !== data.id);
        atualizarDashboardCompleto();
    });

    // --- L√ìGICA DE INTERATIVIDADE DA TABELA ---
    function adicionarListenerTabela() {
        document.getElementById('corpo-tabela-chamados').addEventListener('click', function(event) {
            const target = event.target;
            const row = target.closest('tr.chamado-row');
            if (!row) return;

            if (target.closest('.btn-gerenciar')) {
                event.stopPropagation();
                const chamadoId = parseInt(row.dataset.chamadoId, 10);
                abrirDetalhesModal(chamadoId);
                return;
            }
            
            const detailsRow = document.getElementById(`details-for-${row.id}`);
            document.querySelectorAll('.chamado-details-row').forEach(el => {
                if (el.id !== `details-for-${row.id}`) el.remove();
            });

            if (detailsRow) {
                detailsRow.remove();
            } else {
                const chamadoId = parseInt(row.dataset.chamadoId, 10);
                const chamado = todosChamados.find(c => c.id === chamadoId);
                if (chamado) {
                    const newDetailsRow = document.createElement('tr');
                    newDetailsRow.className = 'chamado-details-row';
                    newDetailsRow.id = `details-for-${row.id}`;
                    newDetailsRow.innerHTML = `
                        <td colspan="7" class="chamado-details-content">
                            <strong>Descri√ß√£o Completa:</strong>
                            <p class="text-muted small mb-0">${chamado.descricao || 'Nenhuma descri√ß√£o fornecida.'}</p>
                        </td>
                    `;
                    row.insertAdjacentElement('afterend', newDetailsRow);
                }
            }
        });
    }

    // --- RENDERIZA√á√ÉO E ATUALIZA√á√ïES DE UI ---
    function atualizarDashboardCompleto() {
        renderizarTabela(todosChamados);
        atualizarKPIs(todosChamados);
        atualizarGraficos(todosChamados);
        atualizarFiltros(todosChamados);
    }

    function renderizarTabela(chamados) {
        const corpoTabela = document.getElementById("corpo-tabela-chamados");
        const filtroSetor = document.getElementById("filtro-setor").value;
        const filtroStatus = document.getElementById("filtro-status").value;
        const filtroBusca = document.getElementById("filtro-busca").value.toLowerCase();
        const chamadosFiltrados = chamados.filter(c =>
            (!filtroSetor || c.setor === filtroSetor) &&
            (!filtroStatus || c.status === filtroStatus) &&
            (!filtroBusca || (c.nome || '').toLowerCase().includes(filtroBusca) || (c.descricao || '').toLowerCase().includes(filtroBusca) || (c.setor || '').toLowerCase().includes(filtroBusca))
        );

        corpoTabela.innerHTML = '';
        if (chamadosFiltrados.length === 0) {
            corpoTabela.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-muted">Nenhum chamado encontrado.</td></tr>`;
            return;
        }

        chamadosFiltrados.forEach(c => {
            const dataStr = formatarData(c.criado_em);
            const statusPill = criarStatusPill(c.status);
            const avatar = criarAvatar(c.nome);
            let tempoAbertoHtml = '<span class="text-muted">--:--:--</span>';
            if (['Aberto', 'Em andamento'].includes(c.status)) {
                tempoAbertoHtml = `<span class="relogio-chamado" data-criado-em="${c.criado_em}">--:--:--</span>`;
            } else if (c.criado_em && c.concluido_em) {
                tempoAbertoHtml = `<span class="text-success">${formatarDuracaoTotal(c.criado_em, c.concluido_em)}</span>`;
            }
            const rowHtml = `
              <tr id="chamado-row-${c.id}" class="chamado-row" data-chamado-id="${c.id}">
                <td class="ps-3">${c.id}</td>
                <td>${dataStr}</td>
                <td class="d-flex align-items-center">${avatar}<span>${c.nome}</span></td>
                <td>${c.setor}</td>
                <td>${statusPill}</td>
                <td class="tempo-aberto-col">${tempoAbertoHtml}</td>
                <td class="text-end pe-3">
                    <button class="btn btn-sm btn-primary btn-gerenciar">
                        <i class="fa-solid fa-pen-to-square"></i> Gerenciar
                    </button>
                </td>
              </tr>`;
            corpoTabela.innerHTML += rowHtml;
        });

        iniciarRelogios();
    }

    // --- FUN√á√ïES AUXILIARES ---
    function formatarData(dataString) {
        if (!dataString) return 'N/A';
        const data = new Date(dataString);
        // Verifica se a data √© v√°lida antes de formatar
        if (isNaN(data.getTime())) {
            return 'Data Inv√°lida';
        }
        return data.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
    }
    function criarAvatar(nome) {
        const iniciais = (nome || '??').split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
        return `<div class="user-avatar">${iniciais}</div>`;
    }
    function criarStatusPill(status) {
        const cor = obterCorStatus(status);
        const icone = obterIconeStatus(status);
        const corTexto = ['Em andamento'].includes(status) ? 'text-dark' : 'text-white';
        return `<span class="status-pill ${corTexto}" style="background-color: ${cor};"><i class="${icone}"></i> ${status}</span>`;
    }
    function obterCorStatus(status) {
        const cores = { 'Aberto': '#dc3545', 'Em andamento': '#ffc107', 'Pendente': '#6c757d', 'Finalizado': '#198754', 'Resolvido': '#198754', 'Conclu√≠do': '#198754' };
        return cores[status] || '#0d6efd';
    }
    function obterIconeStatus(status) {
        const icones = { 'Aberto': 'fa-solid fa-fire', 'Em andamento': 'fa-solid fa-person-digging', 'Pendente': 'fa-solid fa-clock', 'Finalizado': 'fa-solid fa-circle-check', 'Resolvido': 'fa-solid fa-circle-check', 'Conclu√≠do': 'fa-solid fa-circle-check' };
        return icones[status] || 'fa-solid fa-question-circle';
    }

    // --- L√ìGICA DO REL√ìGIO ---
    function iniciarRelogios() {
        if (clockInterval) clearInterval(clockInterval);
        clockInterval = setInterval(() => {
            document.querySelectorAll('.relogio-chamado').forEach(relogio => {
                const criadoEm = relogio.dataset.criadoEm;
                if (criadoEm) {
                    relogio.textContent = formatarDuracao(new Date().getTime() - new Date(criadoEm).getTime());
                }
            });
        }, 1000);
    }
    function formatarDuracao(ms) {
        if (ms < 0) ms = 0;
        const s = Math.floor((ms / 1000) % 60).toString().padStart(2, '0');
        const m = Math.floor((ms / (1000 * 60)) % 60).toString().padStart(2, '0');
        const h = Math.floor(ms / (1000 * 60 * 60)).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }
    function formatarDuracaoTotal(inicioStr, fimStr) {
        return formatarDuracao(new Date(fimStr).getTime() - new Date(inicioStr).getTime());
    }

    // --- TODAS AS OUTRAS FUN√á√ïES COMPLETAS ---
    function desbloquearAudioComInteracao() {
        const desbloquear = () => {
            if (!audioDesbloqueado) {
                notificationSound.muted = true;
                notificationSound.play().then(() => {
                    notificationSound.pause();
                    notificationSound.currentTime = 0;
                    notificationSound.muted = false;
                    audioDesbloqueado = true;
                    console.log("üîä √Åudio desbloqueado.");
                    document.body.removeEventListener('click', desbloquear);
                }).catch(e => {});
            }
        };
        document.body.addEventListener('click', desbloquear, { once: true });
    }

    function inicializarGraficos() {
        const ctxStatus = document.getElementById('grafico-status').getContext('2d');
        graficoStatus = new Chart(ctxStatus, { type: 'bar', data: { labels: [], datasets: [{ data: [], borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        const ctxSetor = document.getElementById('grafico-setor').getContext('2d');
        graficoSetor = new Chart(ctxSetor, { type: 'bar', data: { labels: [], datasets: [{ label: 'N¬∫ de Chamados', data: [], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    async function carregarDadosIniciais() {
        try {
            const resp = await fetch('/api/chamados');
            if (!resp.ok) throw new Error(`Falha ao carregar: ${resp.statusText}`);
            todosChamados = await resp.json();
            atualizarDashboardCompleto();
        } catch (error) {
            console.error(error);
            document.getElementById("corpo-tabela-chamados").innerHTML = `<tr><td colspan="7" class="text-center text-danger">Erro ao carregar os dados.</td></tr>`;
        }
    }

    function adicionarListenersDeFiltro() {
        ['filtro-setor', 'filtro-status', 'filtro-busca'].forEach(id => {
            document.getElementById(id).addEventListener("input", () => renderizarTabela(todosChamados));
        });
        document.getElementById('btn-limpar-filtros').addEventListener('click', () => {
            document.getElementById('filtro-setor').value = '';
            document.getElementById('filtro-status').value = '';
            document.getElementById('filtro-busca').value = '';
            renderizarTabela(todosChamados);
        });
    }

    function atualizarKPIs(chamados) {
        document.getElementById('kpi-abertos').textContent = chamados.filter(c => c.status === 'Aberto').length;
        document.getElementById('kpi-andamento').textContent = chamados.filter(c => c.status === 'Em andamento').length;
        document.getElementById('kpi-pendentes').textContent = chamados.filter(c => c.status === 'Pendente').length;
        const hoje = new Date().toISOString().slice(0, 10);
        document.getElementById('kpi-finalizados-hoje').textContent = chamados.filter(c => ['Finalizado', 'Resolvido', 'Conclu√≠do'].includes(c.status) && c.concluido_em?.startsWith(hoje)).length;
    }

    function atualizarGraficos(chamados) {
        const contagemStatus = chamados.reduce((acc, c) => ({ ...acc, [c.status]: (acc[c.status] || 0) + 1 }), {});
        graficoStatus.data.labels = Object.keys(contagemStatus);
        graficoStatus.data.datasets[0].data = Object.values(contagemStatus);
        graficoStatus.data.datasets[0].backgroundColor = Object.keys(contagemStatus).map(status => obterCorStatus(status));
        graficoStatus.update();

        const contagemSetor = chamados.reduce((acc, c) => ({ ...acc, [c.setor]: (acc[c.setor] || 0) + 1 }), {});
        graficoSetor.data.labels = Object.keys(contagemSetor);
        graficoSetor.data.datasets[0].data = Object.values(contagemSetor);
        graficoSetor.update();
    }

    function atualizarFiltros(chamados) {
        const setores = [...new Set(chamados.map(c => c.setor))].sort();
        document.getElementById('filtro-setor').innerHTML = '<option value="">Todos os Setores</option>' + setores.map(s => `<option value="${s}">${s}</option>`).join('');
        const statuses = [...new Set(chamados.map(c => c.status))].sort();
        document.getElementById('filtro-status').innerHTML = '<option value="">Todos os Status</option>' + statuses.map(s => `<option value="${s}">${s}</option>`).join('');
    }

async function abrirDetalhesModal(chamadoId) {
        const corpoModal = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').textContent = `Gerenciar Chamado #${chamadoId}`;
        corpoModal.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"></div></div>';
        
        const modalEl = document.getElementById('modalChamado');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();

        // Elementos dos bot√µes do footer
        const btnSalvar = document.getElementById('btn-salvar-modal');
        const modalFooter = document.querySelector('#modalChamado .modal-footer');

        // Limpa eventos antigos para evitar m√∫ltiplos cliques
        let novoBtnSalvar = btnSalvar.cloneNode(true);
        btnSalvar.parentNode.replaceChild(novoBtnSalvar, btnSalvar);
        
        let btnExcluir = document.getElementById('btn-excluir-chamado');
        if (btnExcluir) btnExcluir.remove();

        try {
            const chamado = todosChamados.find(c => c.id === chamadoId);
            if (!chamado) throw new Error("Chamado n√£o encontrado na lista local.");

            const [respMetricas, respHist] = await Promise.all([
                fetch(`/api/chamados/${chamadoId}/metricas`),
                fetch(`/api/chamados/${chamadoId}/historico`)
            ]);

            if (!respMetricas.ok || !respHist.ok) throw new Error("Falha ao carregar dados detalhados.");

            const metricas = await respMetricas.json();
            const historico = await respHist.json();

            // --- Constru√ß√£o do HTML do Modal ---
            const metricasHtml = `<div class="row text-center mb-4"><div class="col"><div class="card p-2"><h6 class="card-title mb-1 small text-muted">Tempo de Resolu√ß√£o</h6><p class="card-text fs-4 fw-bold mb-0">${metricas.tempo_total_resolucao_minutos} min</p></div></div><div class="col"><div class="card p-2"><h6 class="card-title mb-1 small text-muted">Tempo Parado</h6><p class="card-text fs-4 fw-bold mb-0">${metricas.tempo_total_pendente_minutos} min</p></div></div></div>`;
            const descricaoHtml = `<div class="mb-4"><h5><i class="fa-solid fa-file-alt me-2"></i>Descri√ß√£o do Problema</h5><p class="p-3 bg-light rounded text-dark small">${chamado.descricao || 'N/A'}</p></div>`;
            const formHtml = `<div class="p-3 border rounded"><h5><i class="fa-solid fa-shuffle me-2"></i>Alterar Status</h5><div class="mb-3"><label for="novo-status" class="form-label">Novo Status</label><select id="novo-status" class="form-select"><option value="Em andamento">Em andamento</option><option value="Pendente">Pendente</option><option value="Finalizado">Finalizado</option></select></div><div><label for="nova-observacao" class="form-label">Adicionar Observa√ß√£o/Resolu√ß√£o</label><textarea id="nova-observacao" class="form-control" rows="3"></textarea></div></div>`;
            let timelineHtml = '<h5 class="mt-4"><i class="fa-solid fa-timeline me-2"></i>Linha do Tempo</h5><ul class="list-group list-group-flush mt-2">';
            if (historico.length > 0) {
                historico.forEach(item => {
                    timelineHtml += `<li class="list-group-item"><p class="mb-1">Status: <strong>${item.de || 'Cria√ß√£o'}</strong> <i class="fa-solid fa-arrow-right-long mx-2"></i> <strong>${item.para}</strong></p><small class="text-muted">${formatarData(item.timestamp)}</small></li>`;
                });
            } else {
                timelineHtml += `<li class="list-group-item text-center text-muted">Nenhum hist√≥rico de mudan√ßa de status.</li>`;
            }
            timelineHtml += '</ul>';

            corpoModal.innerHTML = `${metricasHtml}${descricaoHtml}${formHtml}${timelineHtml}`;

            // --- Fun√ß√µes de A√ß√£o ---
            const handleSave = async () => {
                const novoStatus = document.getElementById('novo-status').value;
                const novaObservacao = document.getElementById('nova-observacao').value;
                const resp = await fetch(`/api/chamados/${chamadoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: novoStatus, observacao: novaObservacao })
                });
                if (resp.ok) {
                    modal.hide();
                } else {
                    alert('Falha ao atualizar o chamado.');
                }
            };

            const handleDelete = async () => {
                if (confirm(`Tem certeza que deseja excluir permanentemente o Chamado #${chamadoId}?`)) {
                    const resp = await fetch(`/api/chamados/${chamadoId}`, { method: 'DELETE' });
                    if (resp.ok) {
                        modal.hide();
                    } else {
                        alert('Falha ao excluir o chamado.');
                    }
                }
            };

            // --- Anexa os eventos aos bot√µes ---
            novoBtnSalvar.addEventListener('click', handleSave);
            
            btnExcluir = document.createElement('button');
            btnExcluir.id = 'btn-excluir-chamado';
            btnExcluir.className = 'btn btn-danger me-auto';
            btnExcluir.innerHTML = '<i class="fa-solid fa-trash me-2"></i>Excluir Chamado';
            modalFooter.prepend(btnExcluir);
            btnExcluir.addEventListener('click', handleDelete);

        } catch (error) {
            corpoModal.innerHTML = `<div class="alert alert-danger"><b>Erro:</b> ${error.message}</div>`;
        }
    }
</script>
{% endblock %}