<style>
    #chatbot-fab {
        position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
        background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white;
        border-radius: 50%; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.3s ease; z-index: 1000; border: none;
    }
    #chatbot-fab:hover { transform: scale(1.1) rotate(15deg); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); }
    #chatbot-fab i { font-size: 24px; transition: transform 0.3s ease; }
    #chatbot-fab.open i { transform: rotate(135deg); }
    #chatbot-window {
        position: fixed; bottom: 90px; right: 20px; width: 360px; height: 550px;
        background-color: #f8f9fa; border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        display: flex; flex-direction: column; overflow: hidden; z-index: 1000;
        border: 1px solid #dee2e6; transform: translateY(20px) scale(0.95);
        opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out;
    }
    #chatbot-window.visible { transform: translateY(0) scale(1); opacity: 1; visibility: visible; }
    #chatbot-header {
        background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white; padding: 1rem;
        font-weight: bold; display: flex; align-items: center; gap: 0.75rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
    .chat-message { padding: 0.6rem 1rem; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
    .chat-message.user { background-color: #0d6efd; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-message.bot { background-color: #ffffff; color: #343a40; align-self: flex-start; border: 1px solid #e9ecef; border-bottom-left-radius: 4px; }
    #chatbot-input-form { display: flex; padding: 0.75rem; border-top: 1px solid #dee2e6; gap: 0.5rem; background-color: #ffffff; }
    #chatbot-input-form input { flex-grow: 1; border: 1px solid #ced4da; border-radius: 20px; padding: 0.6rem 1rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
    #chatbot-input-form input:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
    #chatbot-input-form button { border-radius: 50%; width: 44px; height: 44px; border: none; background-color: #0d6efd; color: white; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0; }
    #chatbot-input-form button:hover { background-color: #0b5ed7; }
</style>

<button id="chatbot-fab" title="Abrir Assistente de IA">
    <i class="fa-solid fa-comment-dots"></i>
</button>

<div id="chatbot-window">
    <div id="chatbot-header">
        <i class="fa-solid fa-robot"></i>
        <span>Assistente de IA - Nicopel</span>
    </div>
    <div id="chatbot-messages">
        <div class="chat-message bot">Olá! Eu sou a Assistente de IA da Nicopel Embalagens. Em que posso ajudar?</div>
    </div>
    <form id="chatbot-input-form">
        <input type="text" id="chatbot-input-text" placeholder="Digite sua mensagem..." autocomplete="off">
        <button type="submit" title="Enviar">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const fab = document.getElementById('chatbot-fab');
        const fabIcon = fab.querySelector('i');
        const chatWindow = document.getElementById('chatbot-window');
        const form = document.getElementById('chatbot-input-form');
        const input = document.getElementById('chatbot-input-text');
        const messagesContainer = document.getElementById('chatbot-messages');

        fab.addEventListener('click', () => {
            chatWindow.classList.toggle('visible');
            fab.classList.toggle('open');
            fabIcon.classList.toggle('fa-comment-dots');
            fabIcon.classList.toggle('fa-xmark');
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = input.value.trim();
            if (userMessage === '') return;

            addMessage(userMessage, 'user');
            input.value = '';
            
            const botMessageDiv = addMessage('<div class="spinner-border spinner-border-sm" role="status"></div>', 'bot');
            
            let fullReply = '';

            try {
                // ✅ CORREÇÃO: A URL agora usa o IP da sua rede local.
                // Lembre-se de verificar se este IP ainda é o correto.
                const response = await fetch('http://10.1.1.85:5000/api/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMessage })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                botMessageDiv.innerHTML = '';
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const data = JSON.parse(line.substring(5));
                            if (data.reply_chunk) {
                                fullReply += data.reply_chunk;
                                const html = marked.parse(fullReply);
                                botMessageDiv.innerHTML = DOMPurify.sanitize(html);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                            if (data.error) {
                                botMessageDiv.textContent = data.error;
                            }
                        }
                    }
                }

            } catch (error) {
                console.error("Erro no chatbot:", error);
                botMessageDiv.textContent = 'Desculpe, estou com problemas para me conectar à IA.';
            }
        });

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.textContent = text;
            } else {
                messageDiv.innerHTML = text;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }
    });
</script>